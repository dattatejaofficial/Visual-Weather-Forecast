<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Weather Visualization</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />

  <!-- Plotly.js -->
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>

  <style>
    body {
      background-color: #121212;
      color: #fff;
    }
    .form-label {
      margin-top: 10px;
    }
    .chart-container {
      height: 500px;
    }
    .info-box {
      background-color: #FFF0F5;
      color: #000;
      padding: 20px;
      border-radius: 10px;
      margin-top: 20px;
    }
  </style>
</head>

<body>
<div class="container mt-4">
  <h1 class="text-center text-warning">Weather Visualization</h1>
  <p class="text-center">Write the name of the city and select the temperature unit and graph type</p>

  <!-- Input Section -->
  <div class="row">
    <div class="col-md-4">
      <label class="form-label">City / State / Country:</label>
      <input type="text" id="city" class="form-control" placeholder="Enter location" />

      <label class="form-label">Temperature Unit:</label>
      <select id="unit" class="form-select">
        <option value="C">Celsius</option>
        <option value="F">Fahrenheit</option>
        <option value="K">Kelvin</option>
      </select>

      <label class="form-label">Graph Type:</label>
      <select id="graphType" class="form-select">
        <option value="line">Line Chart</option>
        <option value="bar">Bar Graph</option>
        <option value="scatter">Scatter Plot</option>
      </select>

      <button class="btn btn-warning mt-3 w-100" onclick="getWeather()">Submit</button>
    </div>

    <div class="col-md-8">
      <div id="graphTitle" class="text-center mt-3"></div>
      <div id="chart" class="chart-container"></div>
      <div id="summary" class="info-box d-none"></div>
    </div>
  </div>
</div>

<script>
  const apiKey = ''; // Replace with your API key

  async function getWeather() {
    const city = document.getElementById("city").value.trim();
    const unit = document.getElementById("unit").value;
    const graph = document.getElementById("graphType").value;

    if (!city) {
      alert("Please enter a city.");
      return;
    }

    // Get Coordinates
    const locationRes = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${city}`);
    const locationData = await locationRes.json();
    if (!locationData[0]) {
      alert("Location not found.");
      return;
    }

    const lat = locationData[0].lat;
    const lon = locationData[0].lon;

    // Call Weather API
    const url = "https://ai-weather-by-meteosource.p.rapidapi.com/hourly";
    const query = `?lat=${lat}&lon=${lon}&timezone=auto&language=en&units=auto`;

    const res = await fetch(url + query, {
      headers: {
        "X-RapidAPI-Key": apiKey,
        "X-RapidAPI-Host": "ai-weather-by-meteosource.p.rapidapi.com"
      }
    });

    const json = await res.json();
    const hourly = json.hourly.data;

    // Filter today's data
    const today = new Date().toISOString().split("T")[0];
    const data = hourly.filter(d => d.date.startsWith(today));

    const time = data.map(d => d.date.split("T")[1].slice(0, 5));
    const tempC = data.map(d => d.temperature);
    const tempF = tempC.map(t => 32 + (9 / 5) * t);
    const tempK = tempC.map(t => 273 + t);
    const summary = data.map(d => d.summary);
    const cloud = data.map(d => d.cloud_cover);
    const wind = data.map(d => d.wind.speed);

    let yData;
    let yLabel;

    if (unit === "C") {
      yData = tempC;
      yLabel = "Temperature (°C)";
    } else if (unit === "F") {
      yData = tempF;
      yLabel = "Temperature (°F)";
    } else {
      yData = tempK;
      yLabel = "Temperature (K)";
    }

    // Plot Graph
    let trace = {
      x: time,
      y: yData,
      mode: graph === "line" ? "lines+markers" : "markers",
      type: graph === "bar" ? "bar" : "scatter",
      marker: { color: "orange" },
      name: yLabel
    };

    document.getElementById("graphTitle").innerHTML = `<h4>${graph.charAt(0).toUpperCase() + graph.slice(1)} of ${yLabel}</h4>`;

    Plotly.newPlot("chart", [trace], {
      paper_bgcolor: "#121212",
      plot_bgcolor: "#121212",
      font: { color: "#fff" },
      xaxis: { title: "Time", tickangle: -45 },
      yaxis: { title: yLabel }
    });

    // Display Summary Stats
    const summaryBox = document.getElementById("summary");
    const modeSummary = summary.sort((a, b) =>
      summary.filter(v => v === a).length - summary.filter(v => v === b).length
    ).pop();

    const avgCloud = cloud.reduce((a, b) => a + b, 0) / cloud.length;
    const avgWind = wind.reduce((a, b) => a + b, 0) / wind.length;

    summaryBox.innerHTML = `
      <h5>Impending Temperature Changes:</h5>
      <p><strong>${modeSummary}</strong></p>
      <h5>Cloud coverage and Wind Speed for ${city}:</h5>
      <p>Average Cloud Cover: ${avgCloud.toFixed(2)}%</p>
      <p>Average Wind Speed: ${avgWind.toFixed(2)} m/s</p>
    `;
    summaryBox.classList.remove("d-none");
  }
</script>

<!-- Bootstrap -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
